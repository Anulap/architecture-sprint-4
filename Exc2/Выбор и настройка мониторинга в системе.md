# Мониторинг

## Анализ текущей архитектуры в контексте интеграции мониторинга

Часть инфраструктуры инструментируется довольно тривиально и не требует трудозатрат разработчиков - это включает стандартные базы данных, брокеры сообщений, хранилища и сами компьютеры. Тем не менее потребуются дополнительные мощности для хранения метрик и их отображения

Остальное ПО потребует ручной инструментализации, к счастью даже купленные решения имеют исходный код, что позволит произвести нужные изменения. Имеет смысл взять стандартное для индустрии решение также совместимое с трейсингом (например OpenTelemetry)

## Мотивация

Мониторинг является жизненно необходимой функционалом для любой системы которая вышла из этапа Proof of Concept (хотя и там он может быть желательным). Свойство наблюдаемости системы (а также её отсутствие) напрямую влияет на деятельность многих специалистов:

- SRE оценят возможность не только быстро реагировать на падение системы (как просто мониторинг, так и автоматизированные уведомления), но и иметь возможность прогнозировать сбой и тем самым его предотвращать
- специалисты связанные с техническим дизайном получат возможность получить планировать изменения, поскольку увидят узкие места в системе, а также получать метрики по результатам внедрения текущих изменений
- аналитики получат больше информации для анализа трендов и отчетности
- внешние клиенты увидят улучшение или просто соблюдение SLA
- пользователи получать улучшенный UX за счёт стабильной работы системы

При этом, нужно заметить что правильное внедрение мониторинга для существующей системы не является тривиальной задачей и потребует реприоритизацию текущих задач, а также расширения инфраструктуры для хранения соответствующих данных, что в текущих условиях для "Александрита" может казаться неправильным решением для менеджмента. Тем не менее именно улучшение наблюдаемости позволит решить текущие проблемы скорейшим образом.

## Выбор подхода к мониторингу

В текущий момент в команде нету специалистов типа SRE. Несмотря на схожий набор экспертиз с DevOps, это всё же отдельная дисциплина, которая требует определённого практического опыта. Будет иметь смысл выбрать какой-нибудь один подход и сконцентрировать усилия именно на нём, существующим специалистам будет проще интерпретировать результаты. В будущем, если будет возможность нанять SRE, появится возможность делегировать такие решения на более компетентных сотрудников. На мой взгляд RED и USE дополняют друг друга потому что по разному смотрят на то как эксплуатируется система (RED - как она используется, USE - как реагирует на нагрузку). Это хороший набор для комплексного анализа поведения системы

В конечном итоге мы лишь выбираем базовые метрики для оценки работоспособности сервисов. Со временем набор метрик, предоставляемых разными сервисами изменится и дополнится в соответствии с требованиями бизнеса и разработки

## Предложение по списку отслеживаемых метрик

Я делаю предположение что мы не только собираем метрики для конкретных методик но и в целом полезные метрики

- Number of dead-letter-exchange letters in RabbitMQ - ошибки доставки RabbitMQ разного вида. Полезно для выявления ошибок
- Number of message in flight in RabbitMQ - может быть критерием Saturation всей системы
- Number of requests (RPS) for internet shop API - часть Saturation по отдельной системе
- Number of requests (RPS) for CRM API - часть Saturation по отдельной системе
- Number of requests (RPS) for MES API - часть Saturation по отдельной системе
- CPU % for shop API - Use для CPU
- CPU % for CRM API - Use для CPU
- CPU % for MES API - Use для CPU
- Memory Utilisation for shop API - Use для RAM
- Memory Utilisation for CRM API - Use для RAM
- Memory Utilisation for MES API - Use для RAM
- Response time (latency) for shop API - для Duration в RED
- Response time (latency) for CRM API - для Duration в RED
- Response time (latency) for MES API - для Duration в RED
- Size of S3 storage - забитое хранилище - критическое событие
- Size of shop db instance - забитое хранилище - критическое событие
- Size of MES db instance - забитое хранилище - критическое событие
- Number of HTTP 500 for shop API - ошибки сервера это важно
- Number of HTTP 500 for CRM API - ошибки сервера это важно
- Number of HTTP 500 for MES API - ошибки сервера это важно
- Number of HTTP 500 for shop API - ошибки сервера это важно

Остальные метрики, на мой взгляд, либо избыточны при грамотном введении USE + RED, либо просто не особенно нужны

## План действий

1. Выбор технологического стека с учётом существующих программных продуктов. Допустим что мы выбрали стандартное для индустрии решения:

    - OpenTelemetry для экспорта метрик
    - Prometheus для скрейпинга и хранения
    - Grafana для отображения и мониторинга
    - Grafana Alerts для уведомления

2. Развернуть элементы инфраструктуры для мониторинга, т.е. Prometheus, Grafana

3. Настроить передачу метрик с использованием стандартных методик для всех серверов и стандартных компонентов, т.е. всех ОС, PostgreSQL, RabbitMQ, S3 storage. Это позволит команде набить руку по работе с метриками в ситуации когда всё должно работать и так

4. Инструментализация сервисов входящих в состав системы. RED можно внедрит в кратчайшие сроки, бОльшая часть библиотек связанных с реализацией RestAPI практически по умолчанию поддерживают как интеграцию с OpenTelemetry, так и экспорт нужных метрик. Составление USE статистик будет требовать больших усилий от доменных экспертов

5. Введение в эксплуатацию. Мониторинг. Анализ инцидентов. Составление Runbook. Предупреждение инцидентов на основе собранных знаний

## Дополнительное задание

На мой взгляд, составление показателей насыщенности для системы без исторических данных и соответствующего профессионального опыта - это дело гиблое. Даже для, казалось бы, стандартных решений вещей вроде Postgres есть [много видений метрик](https://habr.com/ru/articles/514180/). Можно конечно отделаться общими фразами про задачи в очереди, но скорее всего это будут не совсем репрезентативные метрики