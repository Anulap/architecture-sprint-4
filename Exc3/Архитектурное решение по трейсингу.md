# Трейсинг

## Анализ архитектуры в контексте трейсинга

Поскольку проблемы возникают именно с жизненным циклом заказов в системе, имеет смысл в первую очередь покрыть трейсингом именно этот процесс. Итого нужно покрыть весь бекенд, отвечающий за обработку заказа на разных этапах (см. граф состояний заказа), а именно:

- Shop API
- CRM API
- MES API
- MES (в меньшей степени, поскольку вероятность того что нам продали бракованную систему всё же ниже, чем то что мы испытываем интеграционные трудности)

Когда мы говорим о том что должно попасть в трейс, мы конечно же имеем в виду пользовательские данные (считаем что стандартные поля уже и так есть, ориентируясь на имплементацию [OpenTelemetry](https://opentelemetry.io/docs/concepts/signals/traces/)):

- идентификатор клиента
- идентификатор типа клиента (может быть полезно для приоритезации)
- события относительно жизненного цикла заказа в рамках текущего `span`

## Мотивация

Трейсинг - в отличие от мониторинга уже более специализированный инструмент, ориентированный уже в основном на технических специалистов. Он незаменим для проведения некоторых видов анализа системы, конкретно для "Александрита" это может помочь с:

- диагностикой ошибок
- анализом производительности
- мониторинг выполнения SLA в плане соблюдения требований по времени отклика
- поиск аномалий в работе (т.е. не ошибок как таковых, но какой-то сервис в определённый момент может начать работать нетипично)
- анализ потока данных - для новых сотрудников, в отсутствии адекватной документации, трейсы могут использоваться как иллюстрация работы системы в целом

## Предлагаемое решение

[ссылка](../docs/jewerly_c4_model_tracing.drawio)

## Компромиссы

В случае с "Александритом" введение трейсинга не должно вызвать проблем и имеет смысл. Есть факторы, которые серьёзно влияют на целесообразность внедрения трейсинга. Например:

- простая монолитная система
- простая схема распределенного взаимодействия
- низкие требование по SLA
- мало бюджета (ergo нет денег на хранение, дополнительные мощности и т.д.)
- по человеко-часам очень дорого
- нет квалифицированных специалистов

## Безопасность

Тут существует два аспекта безопасности, которые стоит учитывать. Один со стороны инфраструктуры, а второй со стороны ACL

Требования к инфраструктуре:

- зашифрованные каналы передачи данных
- фиксированные endpoint для данных
- маршрутизация трафика, позволяющая данных трейсинга попадать только на сам бекенд трейсинга, а оттуда в БД или на grafana

Со стороны общих правил безопасности:

- доступ к мониторингу (а соответственно и к трейсингу) только из intranet
- ограниченный доступ к intranet извне (только защищенные соединения с логирование, двух-факторная аутентификация)
- ролевая модель авторизации
